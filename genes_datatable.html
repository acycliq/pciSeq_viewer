<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gene Panel</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

  <!-- DataTables core -->
  <link  rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

  <!-- DataTables Select + checkbox plug-in -->
  <link  rel="stylesheet" href="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.11/css/dataTables.checkboxes.css">
  <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
  <script src="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.11/js/dataTables.checkboxes.min.js"></script>

  <!-- glyph helpers -->
  <script src="modules/glyphPaths.js"></script>
  <script src="modules/glyphConfig.js"></script>

  <style>
    body {
      margin: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
      line-height: 1.5;
    }

    h2 {
      margin: 0 0 24px 0;
      font-size: 24px;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 12px;
    }

    .subtitle {
      color: #6c757d;
      margin-bottom: 20px;
      font-size: 14px;
    }

    /* Clean table styling */
    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: white;
    }

    table.dataTable thead th {
      background: #f8f9fa !important;
      color: #495057 !important;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 12px;
      border-bottom: 2px solid #dee2e6;
      border-right: 1px solid #dee2e6;
    }

    table.dataTable thead th:last-child {
      border-right: none;
    }

    table.dataTable tbody td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      background: white;
    }

    table.dataTable tbody td:last-child {
      border-right: none;
    }

    table.dataTable tbody tr:hover td {
      background: #f8f9fa;
    }

    /* Search box */
    .dataTables_filter label {
      color: #495057;
      font-weight: 500;
    }

    .dataTables_filter input {
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 6px 12px;
      margin-left: 8px;
      font-size: 14px;
    }

    .dataTables_filter input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Checkbox styling */
    table.dataTable td.dt-checkboxes-select input {
      transform: scale(1.2);
      accent-color: #007bff;
    }

    /* Color indicator */
    .color-indicator {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #ced4da;
      margin: 0 auto;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Glyph canvas */
    canvas {
      display: block;
      margin: 0 auto;
      border-radius: 2px;
    }

    /* Info text */
    .dataTables_info {
      color: #6c757d;
      font-size: 13px;
      margin-top: 16px;
    }
  </style>
</head>
<body>

<h2>ðŸ§¬ Gene Panel</h2>
<p class="subtitle">Select genes to visualize in the main viewer. Use the search box to quickly find specific genes.</p>

<table id="example" class="display compact" style="width:100%">
  <thead>
    <tr>
      <th></th>
      <th>Gene Name</th>
      <th>Glyph Name</th>
      <th>Glyph Color</th>
      <th>Glyph</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let table;                 // DataTable instance
let preSelected = [];      // genes the viewer says are visible

/* 1 â”€â”€ tell opener this tab is ready */
window.addEventListener('load', () => {
  if (window.opener)
    window.opener.postMessage({ type: 'genePanelReady' }, '*');
});

/* receive gene list from opener and build table */
window.addEventListener('message', (ev) => {
  const msg = ev.data;
  if (!msg || msg.type !== 'geneList') return;

  const genes   = msg.genes;
  preSelected   = msg.chosen.slice();   // clone

  buildTable(genes);
});

/* build and populate DataTable */
function buildTable(genes) {

  const rows = genes.map((g, idx) => {
    const cfg = glyphSettings().find(d => d.gene === g) ||
                glyphSettings().find(d => d.gene === 'Generic');
    return [idx, g, cfg.glyphName, cfg.color];   // four-column row
  });

  table = $('#example').DataTable({
    data: rows,
    paging: false,
    order: [[1, 'asc']],
    select: { style: 'multi' },
    columnDefs: [{
      targets: 0,
      checkboxes: {
        selectRow: false,    // Don't highlight rows
        selectCallback: false // Don't use their callback system
      }
    }],
    columns: [
      { data: 0 },                       // checkbox column (index)
      { data: 1, title: 'Gene Name' },
      { data: 2, title: 'Glyph Name' },
      { data: 3, title: 'Glyph Color',
        render: c => `<div class="color-indicator" style="background:${c}"></div>`
      },
      { title: 'Glyph',
        render: function (data, type, row, meta) {
          const gene = row[1];
          const canv = document.createElement('canvas');
          canv.id = gene; // gene name will be the id
          canv.width = 18;
          canv.height = 18;
          return canv.outerHTML;
        }
      }
    ],
    initComplete: function () {
      // tick every row
      this.api().column(0).checkboxes.select();

      // Draw glyphs on canvases
      rows.forEach(row => {
        const [, gene, glyphName, color] = row;
        const canvas = document.getElementById(gene);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          const p = {x: 9, y: 9};
          const r = ['star5','star6'].includes(glyphName) ? 8 : 6;

          ctxPath(glyphName, ctx, p, r);
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      });

      // Send initial state to main viewer (all genes selected)
      const allGenes = genes.slice(); // All gene names
      if (window.opener) {
        window.opener.postMessage({ type: 'geneVisibilityUpdate', chosen: allGenes }, '*');
      }
    }
  });

  /* whenever user checks/unchecks checkboxes, notify opener */
  $('#example').on('change', 'input[type="checkbox"]', function() {
    // Get all checked checkboxes directly from DOM
    const chosen = [];
    $('#example tbody input[type="checkbox"]:checked').each(function() {
      const row = $(this).closest('tr');
      const rowData = table.row(row).data();
      if (rowData && rowData[1]) {
        chosen.push(rowData[1]); // column 1 = gene name
      }
    });

    console.log('Gene panel: sending', chosen.length, 'selected genes:', chosen.slice(0, 5));

    if (window.opener) {
      window.opener.postMessage({ type: 'geneVisibilityUpdate', chosen: chosen }, '*');
    }
  });
}
</script>

</body>
</html>